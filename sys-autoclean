#!/bin/bash
#
# sys-autoclean - 시스템 자동 관리 스크립트
# 메모리/디스크 임계값 초과 시 자동 정리
#
# cron 설정: */30 * * * * /home/ubuntu/bin/sys-autoclean --auto
# 수동 실행: sys-autoclean
#

# 설정
MEMORY_THRESHOLD=85      # 메모리 임계값 (%)
DISK_THRESHOLD=90        # 디스크 임계값 (%)
LOG_RETENTION_DAYS=7     # 로그 보관 기간 (일)
LOG_FILE="$HOME/.sys-autoclean.log"
ALERT_FILE="$HOME/.sys-alert"

# 색상 (터미널 출력용)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# 로그 함수
log() {
    local msg="[$(date '+%Y-%m-%d %H:%M:%S')] $1"
    echo "$msg" >> "$LOG_FILE"
    if [ "$AUTO_MODE" != "true" ]; then
        echo -e "$msg"
    fi
}

# 메모리 사용률 확인
get_memory_percent() {
    free | grep Mem | awk '{printf "%.0f", $3/$2 * 100}'
}

# 디스크 사용률 확인
get_disk_percent() {
    df / | tail -1 | awk '{print $5}' | tr -d '%'
}

# VS Code 캐시 정리
clean_vscode_cache() {
    log "VS Code 캐시 정리 시작..."

    local vscode_dir="$HOME/.vscode-server"
    local cleaned=0

    if [ -d "$vscode_dir" ]; then
        # 오래된 로그 삭제
        local log_count=$(find "$vscode_dir" -name "*.log" -mtime +$LOG_RETENTION_DAYS 2>/dev/null | wc -l)
        if [ "$log_count" -gt 0 ]; then
            find "$vscode_dir" -name "*.log" -mtime +$LOG_RETENTION_DAYS -delete 2>/dev/null
            log "  - 오래된 로그 $log_count 개 삭제"
            cleaned=$((cleaned + log_count))
        fi

        # VSIX 캐시 삭제
        if [ -d "$vscode_dir/data/CachedExtensionVSIXs" ]; then
            local vsix_size=$(du -sh "$vscode_dir/data/CachedExtensionVSIXs" 2>/dev/null | awk '{print $1}')
            rm -rf "$vscode_dir/data/CachedExtensionVSIXs"/* 2>/dev/null
            log "  - VSIX 캐시 삭제 ($vsix_size)"
        fi

        # 확장 캐시 삭제
        if [ -d "$vscode_dir/data/CachedExtensions" ]; then
            rm -rf "$vscode_dir/data/CachedExtensions"/* 2>/dev/null
            log "  - 확장 캐시 삭제"
        fi

        log "VS Code 캐시 정리 완료"
    else
        log "VS Code 서버 디렉토리 없음"
    fi
}

# 시스템 임시 파일 정리
clean_temp_files() {
    log "임시 파일 정리 시작..."

    # 사용자 임시 파일 (7일 이상)
    local tmp_count=$(find /tmp -user $(whoami) -mtime +$LOG_RETENTION_DAYS 2>/dev/null | wc -l)
    if [ "$tmp_count" -gt 0 ]; then
        find /tmp -user $(whoami) -mtime +$LOG_RETENTION_DAYS -delete 2>/dev/null
        log "  - /tmp 오래된 파일 $tmp_count 개 삭제"
    fi

    # 썸네일 캐시
    if [ -d "$HOME/.cache/thumbnails" ]; then
        rm -rf "$HOME/.cache/thumbnails"/* 2>/dev/null
        log "  - 썸네일 캐시 삭제"
    fi

    log "임시 파일 정리 완료"
}

# 알림 생성
create_alert() {
    local message="$1"
    local timestamp=$(date '+%Y-%m-%d %H:%M:%S')

    echo "[$timestamp] $message" >> "$ALERT_FILE"
    log "⚠️  알림 생성: $message"
}

# 알림 확인
check_alerts() {
    if [ -f "$ALERT_FILE" ]; then
        echo -e "${YELLOW}=== 미확인 알림 ===${NC}"
        cat "$ALERT_FILE"
        echo ""
        read -p "알림을 확인했습니까? (y/N): " confirm
        if [ "$confirm" = "y" ] || [ "$confirm" = "Y" ]; then
            rm -f "$ALERT_FILE"
            echo "알림이 삭제되었습니다."
        fi
    else
        echo "미확인 알림이 없습니다."
    fi
}

# 메인 체크 및 정리 함수
run_check() {
    local mem_percent=$(get_memory_percent)
    local disk_percent=$(get_disk_percent)
    local action_taken=false

    log "===== 시스템 체크 시작 ====="
    log "메모리 사용률: ${mem_percent}% (임계값: ${MEMORY_THRESHOLD}%)"
    log "디스크 사용률: ${disk_percent}% (임계값: ${DISK_THRESHOLD}%)"

    # 메모리 체크
    if [ "$mem_percent" -ge "$MEMORY_THRESHOLD" ]; then
        log "⚠️  메모리 임계값 초과!"
        clean_vscode_cache
        action_taken=true

        # 정리 후 재확인
        sleep 2
        local new_mem=$(get_memory_percent)
        log "정리 후 메모리 사용률: ${new_mem}%"

        if [ "$new_mem" -ge "$MEMORY_THRESHOLD" ]; then
            create_alert "메모리 ${new_mem}% - 캐시 정리 후에도 높음. 수동 확인 필요."
        fi
    fi

    # 디스크 체크
    if [ "$disk_percent" -ge "$DISK_THRESHOLD" ]; then
        log "⚠️  디스크 임계값 초과!"
        clean_vscode_cache
        clean_temp_files
        action_taken=true

        # 정리 후 재확인
        local new_disk=$(get_disk_percent)
        log "정리 후 디스크 사용률: ${new_disk}%"

        if [ "$new_disk" -ge "$DISK_THRESHOLD" ]; then
            create_alert "디스크 ${new_disk}% - 정리 후에도 높음. 수동 확인 필요."
        fi
    fi

    if [ "$action_taken" = false ]; then
        log "시스템 정상 - 정리 불필요"
    fi

    log "===== 시스템 체크 완료 ====="
}

# 예방적 정리 (매일 새벽)
run_daily_clean() {
    log "===== 일일 예방 정리 시작 ====="
    clean_vscode_cache
    clean_temp_files

    # 로그 파일 로테이션 (30일 이상 된 로그 삭제)
    if [ -f "$LOG_FILE" ]; then
        local log_lines=$(wc -l < "$LOG_FILE")
        if [ "$log_lines" -gt 10000 ]; then
            tail -5000 "$LOG_FILE" > "$LOG_FILE.tmp"
            mv "$LOG_FILE.tmp" "$LOG_FILE"
            log "로그 파일 로테이션 완료"
        fi
    fi

    log "===== 일일 예방 정리 완료 ====="
}

# 상태 표시
show_status() {
    local mem_percent=$(get_memory_percent)
    local disk_percent=$(get_disk_percent)

    echo -e "${GREEN}===== 시스템 자동 관리 상태 =====${NC}"
    echo ""
    echo "메모리 사용률: ${mem_percent}% (임계값: ${MEMORY_THRESHOLD}%)"
    echo "디스크 사용률: ${disk_percent}% (임계값: ${DISK_THRESHOLD}%)"
    echo ""

    # 임계값 상태
    if [ "$mem_percent" -ge "$MEMORY_THRESHOLD" ]; then
        echo -e "메모리: ${RED}임계값 초과${NC}"
    else
        echo -e "메모리: ${GREEN}정상${NC}"
    fi

    if [ "$disk_percent" -ge "$DISK_THRESHOLD" ]; then
        echo -e "디스크: ${RED}임계값 초과${NC}"
    else
        echo -e "디스크: ${GREEN}정상${NC}"
    fi

    echo ""

    # cron 등록 상태
    if crontab -l 2>/dev/null | grep -q "sys-autoclean"; then
        echo -e "자동 실행: ${GREEN}활성화${NC}"
    else
        echo -e "자동 실행: ${YELLOW}비활성화${NC}"
    fi

    # 알림 확인
    if [ -f "$ALERT_FILE" ]; then
        echo -e "\n${YELLOW}⚠️  미확인 알림이 있습니다!${NC}"
        echo "   'sys-autoclean --alerts' 로 확인하세요."
    fi

    echo ""
    echo "최근 로그:"
    if [ -f "$LOG_FILE" ]; then
        tail -5 "$LOG_FILE" | sed 's/^/  /'
    else
        echo "  (로그 없음)"
    fi
}

# 도움말
show_help() {
    echo "사용법: sys-autoclean [옵션]"
    echo ""
    echo "옵션:"
    echo "  (없음)      상태 표시"
    echo "  --check     수동으로 체크 및 정리 실행"
    echo "  --auto      자동 모드 (cron용, 출력 없음)"
    echo "  --daily     일일 예방 정리"
    echo "  --clean     강제 캐시 정리"
    echo "  --alerts    미확인 알림 보기"
    echo "  --log       전체 로그 보기"
    echo "  --help      도움말"
}

# 메인 로직
case "${1:-}" in
    --check)
        run_check
        ;;
    --auto)
        AUTO_MODE=true
        run_check
        ;;
    --daily)
        run_daily_clean
        ;;
    --clean)
        clean_vscode_cache
        clean_temp_files
        echo -e "${GREEN}정리 완료${NC}"
        ;;
    --alerts)
        check_alerts
        ;;
    --log)
        if [ -f "$LOG_FILE" ]; then
            less "$LOG_FILE"
        else
            echo "로그 파일이 없습니다."
        fi
        ;;
    --help|-h)
        show_help
        ;;
    "")
        show_status
        ;;
    *)
        echo "알 수 없는 옵션: $1"
        show_help
        exit 1
        ;;
esac
