#!/bin/bash
#
# sysmon - 간단한 시스템 모니터링 스크립트
# 사용법: sysmon [옵션]
#   옵션:
#     --watch    실시간 모니터링 (5초마다 갱신)
#     --clean    VS Code 캐시 정리
#     --fix      NODE_OPTIONS 설정 (메모리 4GB)
#     --help     도움말 표시
#

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color
BOLD='\033[1m'

# 임계값 설정
MEMORY_THRESHOLD=85
CPU_THRESHOLD=80
DISK_THRESHOLD=90

# 상태 플래그
HAS_WARNING=false

# 도움말 출력
show_help() {
    echo "사용법: sysmon [옵션]"
    echo ""
    echo "옵션:"
    echo "  --watch    실시간 모니터링 (5초마다 갱신)"
    echo "  --clean    VS Code 캐시 정리"
    echo "  --fix      NODE_OPTIONS 설정 (메모리 4GB)"
    echo "  --help     이 도움말 표시"
    echo ""
    echo "예시:"
    echo "  sysmon           # 기본 모니터링"
    echo "  sysmon --watch   # 실시간 갱신"
    echo "  sysmon --clean   # 캐시 정리"
    echo "  sysmon --fix     # 메모리 설정 수정"
}

# 상태 아이콘 반환
get_status_icon() {
    local value=$1
    local threshold=$2
    if [ "$value" -ge "$threshold" ]; then
        HAS_WARNING=true
        echo -e "${RED}⚠️  경고!${NC}"
    else
        echo -e "${GREEN}✅${NC}"
    fi
}

# 바이트를 사람이 읽기 쉬운 형태로 변환
bytes_to_human() {
    local bytes=$1
    if [ "$bytes" -ge 1073741824 ]; then
        echo "$(awk "BEGIN {printf \"%.1f\", $bytes/1073741824}")GB"
    elif [ "$bytes" -ge 1048576 ]; then
        echo "$(awk "BEGIN {printf \"%.0f\", $bytes/1048576}")MB"
    else
        echo "$(awk "BEGIN {printf \"%.0f\", $bytes/1024}")KB"
    fi
}

# 메모리 정보 출력
show_memory() {
    local mem_info=$(free -b | grep Mem)
    local total=$(echo $mem_info | awk '{print $2}')
    local used=$(echo $mem_info | awk '{print $3}')
    local available=$(echo $mem_info | awk '{print $7}')
    local percent=$((used * 100 / total))

    local total_h=$(bytes_to_human $total)
    local used_h=$(bytes_to_human $used)
    local status=$(get_status_icon $percent $MEMORY_THRESHOLD)

    echo -e "${CYAN}💾 메모리:${NC} ${used_h} / ${total_h} (${BOLD}${percent}%${NC}) $status"
}

# Swap 정보 출력
show_swap() {
    local swap_info=$(free -b | grep Swap)
    local total=$(echo $swap_info | awk '{print $2}')
    local used=$(echo $swap_info | awk '{print $3}')

    if [ "$total" -eq 0 ]; then
        echo -e "${CYAN}🔄 Swap:${NC} ${YELLOW}미설정${NC}"
    else
        local total_h=$(bytes_to_human $total)
        local used_h=$(bytes_to_human $used)
        echo -e "${CYAN}🔄 Swap:${NC} ${used_h} / ${total_h}"
    fi
}

# CPU 정보 출력
show_cpu() {
    local cpu_idle=$(top -bn1 | grep "Cpu(s)" | awk '{print $8}' | cut -d'.' -f1)
    local cpu_used=$((100 - cpu_idle))
    local load_avg=$(cat /proc/loadavg | awk '{print $1, $2, $3}')
    local status=$(get_status_icon $cpu_used $CPU_THRESHOLD)

    echo -e "${CYAN}💻 CPU:${NC} ${BOLD}${cpu_used}%${NC} $status (로드: $load_avg)"
}

# 디스크 정보 출력
show_disk() {
    local disk_info=$(df -B1 / | tail -1)
    local total=$(echo $disk_info | awk '{print $2}')
    local used=$(echo $disk_info | awk '{print $3}')
    local percent=$(echo $disk_info | awk '{print $5}' | tr -d '%')

    local total_h=$(bytes_to_human $total)
    local used_h=$(bytes_to_human $used)
    local status=$(get_status_icon $percent $DISK_THRESHOLD)

    echo -e "${CYAN}📁 디스크:${NC} ${used_h} / ${total_h} (${BOLD}${percent}%${NC}) $status"
}

# Node.js 설정 확인
show_node_options() {
    local node_opts="${NODE_OPTIONS:-}"

    if [ -z "$node_opts" ]; then
        # .bashrc에서 확인
        if grep -q "NODE_OPTIONS" ~/.bashrc 2>/dev/null; then
            local bashrc_opts=$(grep "NODE_OPTIONS" ~/.bashrc | tail -1 | cut -d'=' -f2- | tr -d '"' | tr -d "'")
            echo -e "${CYAN}⚙️  NODE_OPTIONS:${NC} ${YELLOW}${bashrc_opts}${NC} (재로그인 필요)"
        else
            HAS_WARNING=true
            echo -e "${CYAN}⚙️  NODE_OPTIONS:${NC} ${RED}미설정${NC} - VS Code 메모리 문제 가능"
            echo -e "   ${YELLOW}→ 'sysmon --fix' 로 설정하세요${NC}"
        fi
    else
        if echo "$node_opts" | grep -q "max-old-space-size"; then
            echo -e "${CYAN}⚙️  NODE_OPTIONS:${NC} ${GREEN}${node_opts}${NC} ✅"
        else
            echo -e "${CYAN}⚙️  NODE_OPTIONS:${NC} ${node_opts}"
        fi
    fi
}

# VS Code 프로세스 확인
show_vscode_processes() {
    local vscode_procs=$(ps aux | grep -E "(vscode-server|node.*extensionHost)" | grep -v grep)

    if [ -z "$vscode_procs" ]; then
        echo -e "${CYAN}🖥️  VS Code:${NC} 실행 중인 프로세스 없음"
    else
        local count=$(echo "$vscode_procs" | wc -l)
        local total_mem=$(echo "$vscode_procs" | awk '{sum += $6} END {print sum}')
        local total_mem_h=$(bytes_to_human $((total_mem * 1024)))

        echo -e "${CYAN}🖥️  VS Code:${NC} ${count}개 프로세스, 총 ${BOLD}${total_mem_h}${NC} 사용 중"
    fi
}

# 상위 메모리 사용 프로세스
show_top_processes() {
    echo -e "\n${CYAN}🔝 메모리 상위 프로세스:${NC}"
    ps aux --sort=-%mem | head -6 | tail -5 | awk '{
        mem_kb = $6
        if (mem_kb >= 1048576) {
            mem_str = sprintf("%.1fGB", mem_kb/1048576)
        } else if (mem_kb >= 1024) {
            mem_str = sprintf("%.0fMB", mem_kb/1024)
        } else {
            mem_str = sprintf("%dKB", mem_kb)
        }
        printf "   %d. %-20s %s\n", NR, $11, mem_str
    }'
}

# 전체 상태 표시
show_status() {
    if [ "$HAS_WARNING" = true ]; then
        echo -e "\n${YELLOW}${BOLD}상태: 주의 필요 ⚠️${NC}"
    else
        echo -e "\n${GREEN}${BOLD}상태: 정상 ✅${NC}"
    fi
}

# 메인 모니터링 함수
run_monitor() {
    HAS_WARNING=false

    echo -e "${BOLD}===== 시스템 모니터링 =====${NC}"
    echo -e "${BLUE}📅 $(date '+%Y-%m-%d %H:%M:%S')${NC}"
    echo ""

    show_memory
    show_cpu
    show_disk
    show_swap
    echo ""
    show_node_options
    show_vscode_processes
    show_top_processes
    show_status
}

# VS Code 캐시 정리
clean_vscode() {
    echo -e "${BOLD}VS Code 캐시 정리 중...${NC}"

    # VS Code 서버 캐시 정리
    local vscode_dir="$HOME/.vscode-server"
    if [ -d "$vscode_dir" ]; then
        # 오래된 로그 삭제 (7일 이상)
        find "$vscode_dir" -name "*.log" -mtime +7 -delete 2>/dev/null
        # 캐시 디렉토리 정리
        rm -rf "$vscode_dir/data/CachedExtensionVSIXs"/* 2>/dev/null
        rm -rf "$vscode_dir/data/CachedExtensions"/* 2>/dev/null

        echo -e "${GREEN}✅ VS Code 캐시 정리 완료${NC}"

        # 정리 후 디렉토리 크기
        local size=$(du -sh "$vscode_dir" 2>/dev/null | awk '{print $1}')
        echo -e "   현재 .vscode-server 크기: ${size}"
    else
        echo -e "${YELLOW}VS Code 서버 디렉토리가 없습니다.${NC}"
    fi
}

# NODE_OPTIONS 설정
fix_node_options() {
    local node_line='export NODE_OPTIONS="--max-old-space-size=4096"'

    echo -e "${BOLD}NODE_OPTIONS 설정 중...${NC}"

    # 이미 설정되어 있는지 확인
    if grep -q "max-old-space-size" ~/.bashrc 2>/dev/null; then
        echo -e "${YELLOW}이미 설정되어 있습니다.${NC}"
        grep "NODE_OPTIONS" ~/.bashrc
    else
        # .bashrc에 추가
        echo "" >> ~/.bashrc
        echo "# Node.js 메모리 설정 (VS Code Remote용)" >> ~/.bashrc
        echo "$node_line" >> ~/.bashrc

        echo -e "${GREEN}✅ .bashrc에 NODE_OPTIONS 추가 완료${NC}"
        echo -e "   ${node_line}"
        echo ""
        echo -e "${YELLOW}적용하려면 다음 명령어를 실행하세요:${NC}"
        echo -e "   ${BOLD}source ~/.bashrc${NC}"
        echo ""
        echo -e "또는 새 터미널을 열면 자동 적용됩니다."
    fi
}

# 메인 로직
case "${1:-}" in
    --help|-h)
        show_help
        ;;
    --watch|-w)
        echo "실시간 모니터링 시작 (Ctrl+C로 종료)"
        echo ""
        while true; do
            clear
            run_monitor
            sleep 5
        done
        ;;
    --clean|-c)
        clean_vscode
        ;;
    --fix|-f)
        fix_node_options
        ;;
    "")
        run_monitor
        ;;
    *)
        echo "알 수 없는 옵션: $1"
        echo "도움말: sysmon --help"
        exit 1
        ;;
esac
